<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Sensor Fusion Library: Magnetic Calibration</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Sensor Fusion Library<span id="projectnumber">&#160;0.6.1</span>
   </div>
   <div id="projectbrief">Orientation sensing for Espressif (ESP32, ESP8266) processors</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Magnetic Calibration</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md45"></a> Magnetic Calibration is a fairly involved process. It is process by which corrections to the magnetometer data are determined, which minimize the errors in the final calculated magnetic field vector. These correction values are stored in EEPROM and referred to as the current calibration. Both static and dynamic environmental magnetic disturbances affect the magnetometer; a given calibration remains valid until the magnetic environment of the sensor changes. The present fusion algorithm has automated the calibration process, allowing calibration to run continuously during use of the orientation sensor. Following is an overview of the process.</p>
<h1><a class="anchor" id="autotoc_md46"></a>
Running magnetic calibration</h1>
<p>Calibration is done in time-slices, to avoid excessive CPU load during each fusion cycle. Three versions of calibration exist, differing in complexity and referred to as 4, 7, and 10 element solvers. The higher the order of solver, the more data used to produce the calibration values and theoretically the greater the accuracy.</p>
<p>The firmware runs an in-progress calibration to completion using the same solver. If a calibration is not in progress and has not been done recently (at CAL_INTERVAL_SECS) then one is started using the most complex solver suited to the number of measurements available in the buffer.</p>
<p>A new calibration replaces an existing calibration IF:</p><ul>
<li>mag field strength is within reasonable limits; AND</li>
<li>the fit error is less than 15%; AND</li>
<li>the fit error is better than existing cal OR (is from a higher-order solver AND fit error less than 3.5%).</li>
</ul>
<p>If (the mag field strength is outside reasonable limits OR the fit error is greater than 15%) AND the 10-order solver was used, then it is assumed some readings were corrupted so the buffer is cleared and the cal process restarts.</p>
<p>The fit error of the existing calibration is 'aged' slowly, increasing by 1% every 24 hours. The intention is to account for the magnetic environment changing over time. This causes a new calibration to be favoured over the old one after sufficient time elapses. I am unsure whether this is desirable in a nautical application where it is conceivable for the vessel to be on a consistent heading for long periods.</p>
<h1><a class="anchor" id="autotoc_md47"></a>
Magnetic Calibration Parameters</h1>
<h2><a class="anchor" id="autotoc_md48"></a>
Goodness-of-fit of Current Calibration, and</h2>
<h2><a class="anchor" id="autotoc_md49"></a>
Goodness-of-fit of Candidate Calibration</h2>
<p>The firmware uses recent magnetometer readings to evaluate the goodness of fit of both the currently-used calibration values, and the new candidate (trial) calibration values. Units are in % and a value less than 3.5% is considered good. A value of 0 is returned briefly during program startup, indicating that insufficient data are available to calculate a fit.</p>
<h2><a class="anchor" id="autotoc_md50"></a>
Geomagnetic field magnitude</h2>
<p>This value is the current best-estimate of the B field in uT using recent magnetometer readings. It updates with each new sensor reading added to the buffer. The B field magnitude in effect at the time of an accepted calibration is also stored with that calibration set. This parameter provides an indication of magnetic interference; if the current B value differs widely from the B value of the calibration in use then one can conclude that the calibration is not valid for the present magnetic environment.</p>
<h2><a class="anchor" id="autotoc_md51"></a>
Geomagnetic field inclination from horizontal</h2>
<p>This is the <em>a posteriori</em> value from the Kalman filter output and updates with each sensor reading. It can be used as an indication of magnetic interference; if its value changes by more than, say, 10 degrees from recent previous values then it indicates a disturbance in the magnetic environment. Magnetic inclination values vary over the earth's surface and are available from sources such as NOAA.</p>
<h2><a class="anchor" id="autotoc_md52"></a>
Measurement noise covariance</h2>
<p>This parameter is unitless and is proportional to how heavily the magnetic readings are weighted in calculating the <em>a posteriori</em> orientation. This is a good measure of magnetic interference; when the noise covariance value rises above about 0.00056 it indicates the current magnetic reading does not lie close to the surface of the calibrated geomagnetic sphere.</p>
<h1><a class="anchor" id="autotoc_md53"></a>
More Details</h1>
<p>Further details can be seen in files <code><a class="el" href="magnetic_8c.html" title="Lower level magnetic calibration interface.">sensor_fusion/magnetic.c</a></code> and <code><a class="el" href="sensor__fusion__class_8cc.html" title="An easy-to-use interface to the NXP Sensor Fusion version 7 library algorithms.">sensor_fusion_class.cc</a></code> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Wed Feb 18 2026 09:42:29 for Sensor Fusion Library by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
