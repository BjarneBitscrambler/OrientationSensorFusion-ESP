<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Sensor Fusion Library: Stationary Response</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Sensor Fusion Library<span id="projectnumber">&#160;0.6.1</span>
   </div>
   <div id="projectbrief">Orientation sensing for Espressif (ESP32, ESP8266) processors</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Stationary Response</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md67"></a></p>
<h2><a class="anchor" id="autotoc_md68"></a>
History</h2>
<p>Tests using version 4.2 of the fusion library showed intermittent drifting away from the known heading, even when the sensor is held stationary. It's believed this is caused by a change in the magnetic environment <b>after</b> calibration, such that the calibration is no longer correct. If/when the environment is restored, or the sensor recalibrated, the drifting ceases.</p>
<p>The following testing has been performed using version 7.2 of the fusion code. which includes run-time magnetic calibration. On startup, the code loads any existing calibration from non-volatile memory. Then periodically during operation, it compares the actual magnetometer readings to expected readings and recalculates new calibration coefficients. This should give it more immunity from changes in the magnetic environment.</p>
<h1><a class="anchor" id="autotoc_md69"></a>
Procedure</h1>
<p>An ESP32 loaded with the current fusion code was streaming readings via WiFi to the NXP Sensor Fusion Toolbox software running on a laptop. The sensor system had previously been rotated in the location of the test, until the Toolbox reported completion of magnetic calibration. Accelerometer and gyroscope calibration had <b>not</b> been performed.</p>
<p>Several trials in which the sensor was held steady for several minutes were conducted. Data was logged by the Toolbox to a file, and the reported magnetic heading was later graphed.</p>
<p>Several trials longer than 9 hours were also conducted, with the heading recorded every 1.0 seconds. These tests took place in a household environment with no known disturbances (magnetic or mechanical) in the room, but the air temperature varied between approx 15 - 21 C (low at night, rising in the morning, high during the day, then falling in the evening).</p>
<h1><a class="anchor" id="autotoc_md70"></a>
Results</h1>
<h2><a class="anchor" id="autotoc_md71"></a>
Short-term Variability</h2>
<p>The reported heading varied by about +/- 1 degree over several minutes. A typical plot from one of the trials is shown below. <img src="./images/HeadingDrift.png?raw=true" alt="Heading Drift while sensor stationary" title="Heading Drift while sensor stationary" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md72"></a>
Noise Level</h2>
<p>Over the longer term, the reported heading varied by about +/- 3 degrees in 10 hours, with a standard deviation of 0.76 degrees. The distribution appears approximately Gaussian. It was speculated that changing the sensor reading method to collect more than 1 magnetometer reading per fusion cycle might decrease the variation in heading. However two subsequent tests showed no significant improvement in the distribution of the readings. See the following histogram showing the percentage of total readings deviating given amounts from the mean heading. One data set is for 10.5 hours at the normal data-collection method (5 accel, 5 gyro, and 1 magnetometer sample per fusion cycle), and the second data set was 9 hours collecting 5 samples each of accel, gyro, and magnetometer. There was no noticeable change in the variability, so it does not appear that magnetometer readings are currently the limiting factor in reading stability. <img src="./images/2020-11-20_5-SampleAnd1-SampleHistogram.png?raw=true" alt="Histogram comparing 1- and 5-sample magnetometer readings" title="Histogram comparing 1- and 5-sample magnetometer readings" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md73"></a>
Long-term Variability</h2>
<p>As noted above, the long-term variability had a standard deviation of 0.76 degrees about the mean heading, however all three tests showed an initial period of about 20 - 40 minutes during which the heading rose by about 2 - 3 degrees. I speculate that the increase is related to the fusion algorithm refining its calibration (possibly gyroscope zero-point?), as all three trials commenced with a reboot of the processor. It is not likely due to the system thermally warming up (as during 2 of the trials it had been operating for several hours previous to the test start). Plots are shown below. <img src="./images/2020-11-19_LongtermStability.png?raw=true" alt="Long-term Heading Drift while sensor stationary: 1-sample magnetometer" title="Long-term Heading Drift while sensor stationary" class="inline"/> <img src="./images/2020-11-20Morning_Stability.png?raw=true" alt="Long-term Heading Drift while sensor stationary: 5-sample magnetometer" title="Long-term Heading Drift while sensor stationary: 5-sample magnetometer, morning trial" class="inline"/> <img src="./images/2020-11-20Overnight_Stability.png?raw=true" alt="Long-term Heading Drift while sensor stationary: 5-sample magnetometer, overnight trial" title="Long-term Heading Drift while sensor stationary: 5-sample magnetometer, overnight trial" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md74"></a>
Discussion</h1>
<p>Variability of about +/- 1 degree for the majority of readings seems acceptable. Allowing the sensor to operate for an hour seems to allow it to settle (though it is not yet known whether the settled reading is more accurate than the initial reading). Further improvements might be seen through calibrating the gyro and/or accelerometer. It does not appear that increasing the sampling rate on the magnetometer will improve the readings noticeably given the other current possible contributions to variability.</p>
<h1><a class="anchor" id="autotoc_md75"></a>
Further Work</h1>
<ul>
<li>Tests with calibrated gyro and/or magnetometer</li>
<li>Temperature variation tests (perhaps use built-in temp sensor in sensor IC)</li>
<li>Other starting bearings, like at 90 and 180 degrees from the above tests which were at approx 100 degrees magnetic. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Wed Feb 18 2026 09:42:29 for Sensor Fusion Library by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
