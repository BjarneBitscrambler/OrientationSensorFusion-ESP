<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Sensor Fusion Library: Step Response - Version 7.2 Algorithm</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Sensor Fusion Library<span id="projectnumber">&#160;0.6.1</span>
   </div>
   <div id="projectbrief">Orientation sensing for Espressif (ESP32, ESP8266) processors</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Step Response - Version 7.2 Algorithm</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md76"></a>The below results and discussion relate to testing done with version 7.2 of the NXP Sensor Fusion algorithm (as ported to the ESP platform in this project). Some earlier results using version 4.2 of the NXP Sensor Fusion algorithm (as incorporated in the Adafruit AHRS library) are found below.</p>
<h1><a class="anchor" id="autotoc_md77"></a>
Method</h1>
<p>Place the sensor on a rotatable test fixture. Let the heading reading settle. Manually rotate the fixture at between 50 and 250 degrees/second to a new position and hold the sensor stationary at that position for about 10 seconds. Record the heading as it settles to the new position. Then rotate the fixture back to another starting position and repeat. Use starting positions about 45 or 90 degrees in both directions from the stopping point.</p>
<p>The stopping point was the same in all the trials, but was visually determined so there is an estimated variability in the absolute position of the stopping point of about +/- 1 degree.</p>
<h1><a class="anchor" id="autotoc_md78"></a>
Results</h1>
<p>The heading settles to within about 2 degrees of the stopping point heading in about 1 second. There is a little undershoot, i.e. the heading appears to lag the true position slightly and catches up once the motion has ceased (as judged by the Rate-of-turn parameter from the gyroscope sensor). It was not noticed whether the amount of undershoot was related to the speed of the rotation.</p>
<p>Here is the entire test sequence with 15 trials. <img src="images/2020-11-26_SettlingTime.png" alt="Settling Time Entire Test" class="inline"/></p>
<p>Each of the trials was shifted such that the stopping of motion corresponded with zero-time, and plotted with all 15 trials overlaid. <img src="images/2020-11-26_SettlingTime_Overlay.png" alt="Settling Time Overlaid Trials" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md79"></a>
Discussion</h1>
<p>The settling time after a large rotation seems acceptable. Most vessel motions will be of a slower and smaller amount, so the undershoot will likely be diminished as well (though this hasn't been tested). The repeatability of the heading at the stopping position was good, at about +/- 1.5 degrees, considering that the stopping position was visually judged using a mark on the wheel and therefore had a variability of its own of about 1 or 2 degrees.</p>
<p>It appears, based on these limited trials, that the version 7.2 algorithm is improved over version 4.2 in its ability to settle on the correct heading following a rotation. It is not known what particular change in the algorithm has accomplished this, or even whether it is due to an external factor. More experience using the version 7.2 algorithm may provide more certainty in this.</p>
<h1><a class="anchor" id="autotoc_md80"></a>
Previous Testing</h1>
<h2><a class="anchor" id="autotoc_md81"></a>
Step Response - Version 4.2 Algorithm</h2>
<p>The below results and discussion relate to testing done with version 4.2 of the NXP Sensor Fusion algorithm (as incorporated in the Adafruit AHRS library). Results were not very satisfactory, mainly because of over/undershoot and/or long settling time once motion had stopped. See discussion.</p>
<h2><a class="anchor" id="autotoc_md82"></a>
Method</h2>
<p>Place the sensor on a rotatable test fixture. Let the heading reading settle. Manually rotate the fixture quickly (&lt; 1 second) to a new position and record the heading as it (hopefully) settles to the new position. Then rotate the fixture back to the approximate starting position (to observe the response in both directions).</p>
<h2><a class="anchor" id="autotoc_md83"></a>
Results</h2>
<p>The general behaviour is approximately as expected - the heading adapts to the new orientation after the move. However, there is often a lot of over- or under-shoot in the response, and it takes many (&gt; 5) seconds to close onto the new heading.</p>
<p>This behaviour is not always seen in the same magnitude and it is not yet known why. Compare the following two tests - the first graph shows a large oscillation as the heading converges; the second converges much more rapidly. However the second graph exhibits another undesirable characteristic - i.e. the heading does not always remain constant once motion has stopped.</p>
<p><img src="images/StepMovementAndReturn_20201022.png" alt="Step test 20201022" class="inline"/> Overshoot and undershoot is observed in the filter's Heading output when the sensor is exposed to a quick rotation. In the following graph, the heading output computed by three different filter algorithms (Madgwick, Mahony, and NXP Fusion) is plotted while the test fixture's wheel was manually held stationary, then rotated quickly by about 100 degrees, held stationary, then rotated back to the approximate starting position.</p>
<p><img src="images/StepResponse_20200927.png" alt="Step test 20200927" class="inline"/> This graph shows the sensor reading for heading, plus pitch and roll. The latter two parameters are plotted against the second Y-axis, and they can be seen to be of small magnitude and to settle quickly. It is expected that the pitch and roll change with rotation, as the sensor is attached to the spokes of the wheel, which are not orthogonal to the axis of rotation of the wheel.</p>
<h2><a class="anchor" id="autotoc_md84"></a>
Discussion</h2>
<p>The under/overshoot seems much greater in magnitude than expected, but is not consistent. See the discussion by Kris on (<a href="https://github.com/kriswiner/EM7180_SENtral_sensor_hub/wiki/K.-Limits-of-Absolute-Heading-Accuracy-Using-Inexpensive-MEMS-Sensors">https://github.com/kriswiner/EM7180_SENtral_sensor_hub/wiki/K.-Limits-of-Absolute-Heading-Accuracy-Using-Inexpensive-MEMS-Sensors</a>). His apparatus does differ from the wheel used here: his sensor is mounted coaxial with the fixture and therefore would report very low accelerations while being rotated. Also, his method did not involve a quick step motion, rather he measured position at multiple stationary points with (presumably) the filter output settling after each motion. However, on a vessel it will be critical to respond correctly to abrupt surges/rolls/pitches etc. Regardless, Kris' results suggest that we should be able to achieve accuracy within 2 degrees and currently we see +/- 10 degrees or worse.</p>
<h3><a class="anchor" id="autotoc_md85"></a>
Thoughts</h3>
<ul>
<li>not caused by exceeding maximum rotation speed gyro can report (currently 250 degrees/sec)</li>
<li>doesn't seem to be caused by incorrect scaling of the gyro output, as a separate test in which the wheel was allowed to freely rotate showed that the rotation reported by the gyro corresponded within ~3% of the rate measured by a position sensor located on the rim of the wheel.</li>
<li>the sensor defaults to not using the built-in 32-sample FIFO - i.e. the measured rotations are realtime, not buffered. So it does not appear to be caused by a temporal lag between actual motion and measured motion. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Wed Feb 18 2026 09:42:29 for Sensor Fusion Library by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
