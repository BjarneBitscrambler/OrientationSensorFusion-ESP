<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Sensor Fusion Library: Magnetic Disturbances</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Sensor Fusion Library<span id="projectnumber">&#160;0.6.1</span>
   </div>
   <div id="projectbrief">Orientation sensing for Espressif (ESP32, ESP8266) processors</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Magnetic Disturbances</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md54"></a> Even if an effective calibration is performed at the time of sensor installation, it is almost inevitable that at some point magnetic disturbances will occur in the vicinity, thus diminishing the sensor accuracy. These disturbances can include things like: new ferromagnetic objects brought into the area; new electrical wires; compasses, speakers, laptops placed nearby; etc. It is preferable to know when a magnetic disturbance is occurring so that it can be remedied. either by removing the object or performing a new calibration.</p>
<h1><a class="anchor" id="autotoc_md55"></a>
Detecting Magnetic Interference</h1>
<p>Close review of the sensor fusion code and NXP's Application Note AN5019 <em>Magnetic Calibration Algorithms</em> suggested several indicators of reliability of the magnetic readings. Assuming that one already has a good calibration in use, then monitoring the <b>Measurement Noise Covariance Matrix</b> (array variable <code>fQv6x1</code> in <code><a class="el" href="fusion_8c.html" title="Lower level sensor fusion interface.">fusion.c</a></code>) seems to work well. Specifically, <code>fQv6x1[3]</code> corresponds to the magnetic noise covariance for the current sensor reading, and is used by the fusion algorithm in determining how much weight to assign to the magnetic reading when calculating the orientation.</p>
<p>The <em>magnetic measurement noise covariance</em> is a float value. Some testing (below) suggests that when the time-average over 1 second of this value rises above 0.00056 there is significant magnetic interference.</p>
<h1><a class="anchor" id="autotoc_md56"></a>
Test Method</h1>
<p>The sensor was connected to an ESP8266 d1_mini programmed to output several key values every 100 ms. These values were:</p><ul>
<li>the B field magnitude in uT assumed by the calibration parameters</li>
<li>the B field inclination (dip below horizontal) in degrees of the present sensor reading</li>
<li>the magnetic measurement noise covariance as calculated by the fusion algorithm</li>
</ul>
<p>The sensor was powered up and handheld at least 50 cm from the nearest metal and at least 1 m from the nearest magnet. For the first 60 seconds it was rotated arbitrarily to acquire enough readings to perform a calibration. It was then held stationary for about 30 s, followed by 30 s of moderate motion (pitch, roll, and yaw of about 30 degrees). Then for the next 30 s a pen known to have a steel barrel was brought within 5 cm of the sensor and moved arbitrarily in various orientations. The pen was removed and replaced by a 5 mm dia rare earth magnet, which was moved in the vicinity of the sensor at a distance of about 10 cm. Finally, the magnet was removed and the sensor manipulated moderately by hand for 30 s, followed by holding the sensor stationary for the rest of the test.</p>
<h1><a class="anchor" id="autotoc_md57"></a>
Results</h1>
<p>Calibration was successful, as evidenced by the <b>B</b> field magnitude of about 49 uT contained in the calibration parameters. Three steps are visible in the <b>B</b> plot, corresponding to the completion of the 4-, 7-, and 10-element calibration routines. <br  />
</p>
<p>The magnetic <b>inclination angle</b> of about 70 degrees is as expected, and is one possible indicator of magnetic disturbances provided that the <b>threshold of</b> determining a disturbance allows a swing of <b>about +/- 5 degrees from the average undisturbed value</b>.</p>
<p>The <b>magnetic noise covariance</b> is a more powerful determinant of whether interference is occurring. This was visualized easiest by plotting a 1 s time-average of the log of the noise covariance value. This parameter remained less than -3.25 during all the un-interfered periods, and rose markedly higher when subjected to interference by the pen and the magnet. If one assumes a threshold of -3.25, this would correspond to an actual noise covariance <b>value of 0.00056; if this parameter rises above this level one can assume that magnetic interference is present</b>.</p>
<p>Results are shown here: <img src="./images/2021-01-25_MagneticInterference.png?raw=true" alt="Key Parameters reported by sensor during Magnetic Disturbances" title="Key parameters reported during Magnetic Disturbances" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md58"></a>
Further Testing</h1>
<p>A test reporting the compass heading simultaneous with the above magnetic parameters, while the sensor is subjected to a disturbance, would be useful to confirm that the thresholds at which the parameters indicate interference correspond with actual distubrances in the compass heading. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Wed Feb 18 2026 09:42:29 for Sensor Fusion Library by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
